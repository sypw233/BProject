name: Quick Build & Test

# å¿«é€Ÿæž„å»ºå’Œæµ‹è¯•å·¥ä½œæµï¼Œç”¨äºŽå¼€å‘é˜¶æ®µçš„å¿«é€ŸéªŒè¯
on:
  push:
    branches: [ develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # å¿«é€Ÿæž„å»ºæµ‹è¯•ï¼ˆä»…Windowsï¼‰
  quick-build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      shell: bash
      
    # è¿è¡Œæµ‹è¯•
    - name: Run Tests
      run: ./gradlew :composeApp:testDebugUnitTest
      shell: bash
      continue-on-error: true
      
    # ç¼–è¯‘æ£€æŸ¥
    - name: Compile Check
      run: ./gradlew :composeApp:compileKotlinDesktop
      shell: bash
      
    # å¿«é€Ÿæž„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¸æ‰“åŒ…ï¼‰
    - name: Quick Build Executable
      run: ./gradlew :composeApp:createDistributable
      shell: bash
      
    # éªŒè¯æž„å»ºç»“æžœ
    - name: Verify Build
      run: |
        echo "æ£€æŸ¥æž„å»ºäº§ç‰©..."
        if [ -d "composeApp/build/compose/binaries/main/app" ]; then
          echo "âœ… æž„å»ºæˆåŠŸï¼"
          ls -la composeApp/build/compose/binaries/main/app/
        else
          echo "âŒ æž„å»ºå¤±è´¥ï¼"
          exit 1
        fi
      shell: bash
      
    # ä¸Šä¼ æž„å»ºäº§ç‰©ï¼ˆä»…ä¿ç•™7å¤©ï¼‰
    - name: Upload Quick Build
      uses: actions/upload-artifact@v4
      with:
        name: quick-build-${{ github.sha }}
        path: composeApp/build/compose/binaries/main/app/
        retention-days: 7
        
    # æž„å»ºæ‘˜è¦
    - name: Build Summary
      run: |
        echo "## ðŸš€ å¿«é€Ÿæž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸‹è½½æž„å»ºäº§ç‰©è¿›è¡Œæœ¬åœ°æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- å¦‚éœ€æ­£å¼å‘å¸ƒï¼Œè¯·åˆå¹¶åˆ°mainåˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
      shell: bash