name: Build Multi-Platform Apps

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°mainåˆ†æ”¯æˆ–åˆ›å»ºtagæ—¶
on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # Windowsæ„å»ºä»»åŠ¡ï¼ˆä»…å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      shell: bash
      
    # æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¸åŒ…å«MSIï¼‰
    - name: Build Windows Executable
      run: ./gradlew :composeApp:createDistributable
      shell: bash
      
    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-desktop-app
        path: composeApp/build/compose/binaries/main/app/
        retention-days: 30

  # Androidæ„å»ºä»»åŠ¡
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    # æ„å»ºAndroid APK
    - name: Build Android APK
      run: ./gradlew :composeApp:assembleRelease
      
    - name: Upload Android Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: |
          composeApp/build/outputs/apk/release/*.apk
        retention-days: 30

  # macOSæ„å»ºä»»åŠ¡
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    # æ„å»ºmacOS DMGå®‰è£…åŒ…
    - name: Build macOS DMG
      run: ./gradlew :composeApp:packageDmg
      
    - name: Upload macOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-desktop-app
        path: |
          composeApp/build/compose/binaries/main/dmg/*.dmg
          composeApp/build/compose/binaries/main/app/
        retention-days: 30

  # Linuxæ„å»ºä»»åŠ¡
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    # æ„å»ºLinux DEBå®‰è£…åŒ…
    - name: Build Linux DEB
      run: ./gradlew :composeApp:packageDeb
      
    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-desktop-app
        path: |
          composeApp/build/compose/binaries/main/deb/*.deb
          composeApp/build/compose/binaries/main/app/
        retention-days: 30

  # åˆ›å»ºReleaseï¼ˆç¼–è¯‘å®Œæˆåè‡ªåŠ¨å‘å¸ƒï¼‰
  create-release:
    needs: [build-windows, build-android, build-macos, build-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Windows Artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-desktop-app
        path: ./artifacts/windows/
        
    - name: Download Android Artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-app
        path: ./artifacts/android/
        
    - name: Download macOS Artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-desktop-app
        path: ./artifacts/macos/
        
    - name: Download Linux Artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-desktop-app
        path: ./artifacts/linux/
        
    # æ‰“åŒ…Windowså¯æ‰§è¡Œæ–‡ä»¶
    - name: Package Windows App
      run: |
        cd ./artifacts/windows/
        zip -r ../../windows-app.zip .
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./windows-app.zip
          ./artifacts/android/*.apk
          ./artifacts/macos/**/*.dmg
          ./artifacts/linux/**/*.deb
        draft: false
        prerelease: false
        tag_name: ${{ github.ref_name != 'main' && github.ref_name || format('v{0}', github.run_number) }}
        name: ${{ github.ref_name != 'main' && github.ref_name || format('Release v{0}', github.run_number) }}
        body: |
          ## ğŸš€ å¤šå¹³å°åº”ç”¨å‘å¸ƒ
          
          ### æ”¯æŒå¹³å°
          - âœ… Windows (å¯æ‰§è¡Œæ–‡ä»¶å‹ç¼©åŒ…)
          - âœ… Android (APKå®‰è£…åŒ…)
          - âœ… macOS (DMGå®‰è£…åŒ…)
          - âœ… Linux (DEBå®‰è£…åŒ…)
          
          ### æŠ€æœ¯æ ˆ
          - Kotlin Multiplatform
          - Compose Multiplatform
          - JDK 21
          
          ### å®‰è£…è¯´æ˜
          1. **Windows**: ä¸‹è½½ `windows-app.zip` æ–‡ä»¶ï¼Œè§£å‹åè¿è¡Œexeæ–‡ä»¶
          2. **Android**: ä¸‹è½½ `.apk` æ–‡ä»¶å¹¶å®‰è£…
          3. **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          4. **Linux**: ä¸‹è½½ `.deb` æ–‡ä»¶ï¼Œä½¿ç”¨ `sudo dpkg -i filename.deb` å®‰è£…
          
          ### æ›´æ–°å†…å®¹
          - æœ€æ–°çš„åŠŸèƒ½æ›´æ–°å’Œbugä¿®å¤
          - æ€§èƒ½ä¼˜åŒ–å’Œç¨³å®šæ€§æå‡
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}